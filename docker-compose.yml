services:
  # ---------------------------------------------------------
  # SCADA Master (The Client polling the network)
  # ---------------------------------------------------------
  scada_master:
    build: .
    container_name: scada_master
    networks:
      grid_macvlan:
        ipv4_address: 10.30.0.16  # Assign a static IP on your physical subnet
    # Command to run your master script. 
    command: ["python", "/app/scripts/master_poller.py"]

  # ---------------------------------------------------------
  # Transmission RTU (High-Voltage Substation Server)
  # ---------------------------------------------------------
  tx_rtu:
    build: .
    container_name: tx_rtu
    networks:
      grid_macvlan:
        ipv4_address: 10.30.0.17
    ports:
      - "502:502" # Expose standard Modbus port
    command: ["python", "/app/scripts/server_tx_rtu.py"]

  # ---------------------------------------------------------
  # Distribution IED (Breaker Relay Server)
  # ---------------------------------------------------------
  dist_ied:
    build: .
    container_name: dist_ied
    networks:
      grid_macvlan:
        ipv4_address: 10.30.0.18
    ports:
      - "502:502"
    command: ["python", "/app/scripts/server_dist_ied.py"]

  # ---------------------------------------------------------
  # Transformer Monitor (Analog Sensor Server)
  # ---------------------------------------------------------
  transformer_sensor:
    build: .
    container_name: transformer_sensor
    networks:
      grid_macvlan:
        ipv4_address: 10.30.0.19
    ports:
      - "502:502"
    command: ["python", "/app/scripts/server_transformer.py"]

# ---------------------------------------------------------
# Network Configuration (CRITICAL STEP)
# ---------------------------------------------------------
networks:
  grid_macvlan:
    driver: macvlan
    driver_opts:
      # VM's primary interface facing pfSense
      parent: enp6s20
    ipam:
      config:
        - subnet: "10.30.0.0/24"     # physical network subnet
          gateway: "10.30.0.254"       # pfSense IP address
          # Exclude IPs already used by DHCP on your pfSense to avoid conflicts
          ip_range: "10.30.0.16/25"
